<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>B64 Transfer</title>
<style type="text/css">
*{box-sizing:border-box;}
body{margin:0;}
button{padding:1px 3px;}
details{display:block;}
img,audio,video{border:1px solid #7F7F7F;display:inline-block;max-width:100%;}
label{display:inline-block;}
summary h3,summary h4{display:inline;}
table{border-collapse:collapse;}
table tr th,table tr td{border:1px solid #7f7f7f;padding:2px 5px;}
ul{margin:0;padding-left:25px;}
.breakWord{overflow-wrap:break-word;}
.container{padding:10px 15px;}
.declare{color:#ff3f3f;font-weight:bold;}
.mLeftM{margin-left:15px;}
.mrm{margin-right:15px;}
.mRightXS{margin-right:5px;}
.mTopS{margin-top:8px;}
.noWrap{white-space:nowrap;word-break:keep-all;}
.popup{padding:5px;background-color:#efffff;border:1px solid gray;position:absolute;z-index:999;}
.popup>span{display:block;}
.popup>span:not(:first-child){margin-top:3px;}
.remark{color:#3f3f3f;font-family:'新宋体';font-size:0.8rem;}
.toast{padding:5px 15px;z-index:100;border-style:solid;border-width:1px;justify-content:center;align-items:center;}
.wordWrap{word-break:break-word;overflow-wrap:anywhere;}
</style>
<script type="text/javascript">
const UT=(()=>{
  const Excp=function(msg,cause){
    this.msg=msg;
    this.cause=cause;
  };
  const preProm=exec=>()=>new Promise(exec);
  const serial=prePms=>async()=>{
    let ret=[];
    for(prePm of prePms){
      ret.push(await prePm());
    }
    return ret;
  };
  const parallel=prePms=>()=>Promise.all(prePms.map(prePm=>prePm()));
  const byid=id=>document.getElementById(id);
  const fcc=String.fromCharCode;
  const utf8En=text=>{
    let code='';
    for(let i=0;i<text.length;i++){
      const c=text.charCodeAt(i);
      code+=c<0x80?fcc(c):c<0x800?(fcc((c>>>6)|0xC0)+fcc(c&0x3F|0x80)):(fcc((c>>>12)|0xE0)+fcc((c>>>6)&0x3F|0x80)+fcc(c&0x3F|0x80));
    }
    return code;
  };
  const utf8De=code=>{
    let text='';
    for(let i=0;i<code.length;i++){
      const c=code.charCodeAt(i);
      text+=c<0x80?fcc(c):c<0xE0?fcc(((c&0x1F)<<6)|(code.charCodeAt(++i)&0x3F)):fcc(((c&0x0F)<<12)|((code.charCodeAt(++i)&0x3F)<<6)|(code.charCodeAt(++i)&0x3F));
    }
    return text;
  };
  const url2Blob=url=>{
    const frag=url.split(',');
    const mime=frag[0].match(/:(.*?);/)[1];
    const bytes=atob(frag[1]);
    let l=bytes.length;
    const arr=new Uint8Array(l);
    while(l--){
      arr[l]=bytes.charCodeAt(l);
    }
    return new Blob([arr.buffer],{type:mime});
  };
  const loadFile=(load,emsg)=>preProm((ok,err)=>{
    try{
      const r=new FileReader();
      r.onloadend=e=>{
        if(e.target.error){
          err(new Excp(emsg,e.target.error));
        }else{
          ok(e.target.result);
        }
      };
      load(r);
    }catch(t){
      err(new Excp(emsg,t));
    }
  });
  const loadAsUrl=(file,emsg)=>loadFile(r=>r.readAsDataURL(file),emsg);
  const loadAsBuff=(file,emsg)=>loadFile(r=>r.readAsArrayBuffer(file),emsg);
  return {
    Excp:Excp,
    preProm:preProm,
    serial:serial,
    parallel:parallel,
    fcc:fcc,
    utf8En:utf8En,
    utf8De:utf8De,
    url2Blob:url2Blob,
    loadFile:loadFile,
    loadAsUrl:loadAsUrl,
    loadAsBuff:loadAsBuff
  };
})();

const CF=(()=>{
  const F0=0,F1=3,FLV=3,IDLI=UT.fcc(1),IEND=UT.fcc(0);
  const ERR={
    CLOAK_FAIL:'CLOAK_FAIL',
    DECLOAK_FAIL:'DECLOAK_FAIL',
    DECLOAK_CROSS_ORIGIN_ERR:'DECLOAK_CROSS_ORIGIN_ERR',
    INFILE_INVLD:'INFILE_INVLD'
  };
  const genAux=lv=>({
    range:1<<lv,
    half:(1<<lv)>>>1,
    maskH:-1<<lv,
    maskL:~(-1<<lv)
  });
  const abut=(b,t,aux)=>{
    if(aux.range<=2){
      return b&aux.maskH|t;
    }
    const bL=b&aux.maskL;
    return (b<aux.half||b>=0xFF-aux.half)?(b&aux.maskH|t):(t-bL>aux.half)?((b&aux.maskH|t)-aux.range):(bL-t>=aux.half)?((b&aux.maskH|t)+aux.range):(b&aux.maskH|t);
  };
  const Pkg=function(data,lv,clk){
    this.data=data;
    this.lv=lv;
    this.buff=0;
    this.bits=0;
    this.idx=4;
    this.aux=genAux(lv);
    this.clk=clk;
  };
  Pkg.prototype.implantSeg=function(next){
    if(!this.clk){
      return;
    }
    let i=0;
    while(this.idx<this.data.length){
      const b=next(i++);
      if(b<0){
        break;
      }
      this.buff=(this.buff<<8)|b;
      this.bits+=8;
      this.flush();
    }
  };
  Pkg.prototype.flush=function(end){
    if(!this.clk){
      return;
    }
    while(this.idx<this.data.length&&this.bits>=this.lv){
      this.data[this.idx]=abut(this.data[this.idx],(this.buff>>>(this.bits-this.lv))&this.aux.maskL,this.aux);
      this.bits-=this.lv;
      this.idx++;
      if((this.idx&3)===3){
        this.idx++;
      }
    }
    if(end&&this.idx<this.data.length&&this.bits>0){
      this.data[this.idx]=abut(this.data[this.idx],(this.buff<<(this.lv-this.bits))&this.aux.maskL,this.aux);
      this.idx++;
    }
  };
  Pkg.prototype.extractBytes=function(onByte){
    if(this.clk){
      return;
    }
    let i=0,goon=true;
    while(this.idx<this.data.length&&goon){
      this.buff=(this.buff<<this.lv)|(this.data[this.idx]&this.aux.maskL);
      this.bits+=this.lv;
      this.idx++;
      if((this.idx&3)===3){
        this.idx++;
      }
      if(this.bits>=8){
        goon=onByte((this.buff>>>(this.bits-8))&0xFF)!==false;
        this.bits-=8;
      }
    }
  };
  const adjMinSize=(imgW,imgH,minW,minH)=>{
    const h=Math.round(minW*imgH/imgW);
    if(h<minH){
      minW=Math.max(minW,Math.round(minH*imgW/imgH));
    }else{
      minH=h;
    }
    return [minW,minH];
  };
  const calcSizeLv=(bits,maxLv,imgW,imgH,minW,minH,shrink)=>{
    const minSize=adjMinSize(imgW,imgH,minW,minH);
    minW=minSize[0];
    minH=minSize[1];
    const noShk=shrink!=='TEMPERATE'&&shrink!=='EXTREME';
    if(noShk){
      minW=Math.max(imgW,minW);
      minH=Math.max(imgH,minH);
    }
    const imgPx=imgW*imgH,minPx=minW*minH;
    let lv=0,needPx=0;
    do{
      lv++;
      needPx=Math.ceil(bits/(lv*3))+1;
    }while(lv<maxLv&&needPx>minPx&&(needPx>imgPx||shrink==='EXTREME'));
    let w=imgW,h=imgH;
    if(needPx<=minPx){
      w=minW;
      h=minH;
    }else if(needPx>imgPx||(!noShk&&needPx<imgPx)){
      const scale=Math.sqrt(needPx/imgPx);
      w=Math.ceil(scale*w);
      h=Math.ceil(scale*h);
    }
    return [w,h,lv];
  };
  const implant=(outImg,inData,info,lv)=>{
    const faux=genAux(FLV);
    const outData=outImg.data;
    outData[0]=abut(outData[0],F0,faux);
    outData[1]=abut(outData[1],F1,faux);
    outData[2]=abut(outData[2],lv,faux);
    const pkg=new Pkg(outData,lv,true);
    pkg.implantSeg(i=>i<info.length?info.charCodeAt(i):-1);
    pkg.implantSeg(i=>i<inData.length?inData[i]:-1);
    pkg.flush(true);
    const cvs=document.createElement("canvas");
    cvs.width=outImg.width;
    cvs.height=outImg.height;
    const ctx=cvs.getContext("2d");
    ctx.putImageData(outImg,0,0);
    return cvs.toDataURL();
  };
  const extract=data=>{
    const fmaskL=~(-1<<FLV);
    const f0=data[0]&fmaskL;
    const f1=data[1]&fmaskL;
    const lv=data[2]&fmaskL;
    if(f0!==F0||f1!==F1||lv<1||lv>7){
      throw new UT.Excp(ERR.INFILE_INVLD,new Error());
    }
    const pkg=new Pkg(data,lv,false);
    let info='';
    pkg.extractBytes(b=>{
      const c=UT.fcc(b);
      if(c===IEND){
        return false;
      }
      info+=c;
    });
    const frag=info.split(IDLI);
    if(frag.length!==3){
      throw new UT.Excp(ERR.INFILE_INVLD,new Error());
    }
    const len=parseInt(frag[0]);
    if(len<0){
      throw new UT.Excp(ERR.INFILE_INVLD,new Error());
    }
    const arr=new Uint8Array(len);
    let i=0;
    pkg.extractBytes(b=>{
      if(i>=len){
        return false;
      }
      arr[i++]=b;
    });
    return new File([arr.buffer],UT.utf8De(frag[1]),{type:frag[2]});
  };
  const cloak=para=>UT.preProm((ok,err)=>{
    try{
      const inData=new Uint8Array(para.inBuff);
      const info=inData.length+IDLI+UT.utf8En(para.inName)+IDLI+para.inType+IEND;
      const outImg=new Image();
      outImg.onload=()=>{
        try{
          const sizeLv=calcSizeLv((info.length+inData.length)*8,para.maxLv,outImg.width,outImg.height,para.minWidth,para.minHeight,para.shrink);
          const cvs=document.createElement("canvas");
          cvs.width=sizeLv[0];
          cvs.height=sizeLv[1];
          const ctx=cvs.getContext("2d");
          ctx.fillStyle="#ffffff";
          ctx.fillRect(0,0,sizeLv[0],sizeLv[1]);
          ctx.drawImage(outImg,0,0,sizeLv[0],sizeLv[1]);
          if(para.remark){
            ctx.font="16px Arial";
            ctx.textBaseline="middle";
            ctx.fillStyle="rgba(255,255,255,0.75)";
            ctx.fillRect(0,0,ctx.measureText(para.remark).width+8,28);
            ctx.fillStyle="#000000";
            ctx.fillText(para.remark,4,14,sizeLv[0]-8);
          }
          const blob=UT.url2Blob(implant(ctx.getImageData(0,0,sizeLv[0],sizeLv[1]),inData,info,sizeLv[2]));
          ok(new File([blob],para.outName,{type:blob.type}));
        }catch(t){
          err((t instanceof UT.Excp)?t:new UT.Excp(ERR.CLOAK_FAIL,t));
        }
      };
      outImg.onerror=e=>err(new UT.Excp(ERR.CLOAK_FAIL,e));
      outImg.src=para.outUrl;
    }catch(t){
      err((t instanceof UT.Excp)?t:new UT.Excp(ERR.CLOAK_FAIL,t));
    }
  });
  const decloak=url=>UT.preProm((ok,err)=>{
    try{
      const img=new Image();
      img.crossOrigin='Anonymous';
      img.onload=()=>{
        try{
          const cvs=document.createElement("canvas");
          cvs.width=img.width;
          cvs.height=img.height;
          const ctx=cvs.getContext("2d");
          ctx.drawImage(img,0,0);
          ok(extract(ctx.getImageData(0,0,img.width,img.height).data));
        }catch(t){
          err((t instanceof UT.Excp)?t:new UT.Excp(t.message&&t.message.toLowerCase().indexOf('cross-origin')>=0?ERR.DECLOAK_CROSS_ORIGIN_ERR:ERR.DECLOAK_FAIL,t));
        }
      };
      img.onerror=e=>err(new UT.Excp(ERR.DECLOAK_FAIL,e));
      img.src=url;
    }catch(t){
      err((t instanceof UT.Excp)?t:new UT.Excp(ERR.DECLOAK_FAIL,t));
    }
  });
  return {
    ERR:ERR,
    cloak:cloak,
    decloak:decloak
  };
})();

(()=>{

const _VER_HIS=[
  ['1.0','2021-07-07','初始创建。']
];
const _META={
  warnSize:31457280,
  warnText:'30MB'
};

const Kit=(()=>{
  const Excp=function(msg,cause){
    this.msg=msg;
    this.cause=cause;
  };
  const Cls=function(){};
  Cls.prototype.empty=function(val){return val==null||val==='';};
  Cls.prototype.notEmpty=function(val){return !this.empty(val);};
  Cls.prototype.byid=function(id){return document.getElementById(id);};
  Cls.prototype.celmt=function(name){return document.createElement(name);};
  Cls.prototype.ctext=function(text){return document.createTextNode(text);};
  Cls.prototype.setText=function(dom,text){
    dom.innerHTML='';
    this.notEmpty(text)&&dom.appendChild(this.ctext(text));
  };
  Cls.prototype.excp=function(msg,cause){return new Excp(msg,cause);};
  Cls.prototype.preProm=function(exec){return ()=>new Promise(exec);};
  Cls.prototype.serial=function(prePms){
    return async()=>{
      let ret=[];
      for(prePm of prePms){
        ret.push(await prePm());
      }
      return ret;
    };
  };
  Cls.prototype.parallel=function(prePms){return ()=>Promise.all(prePms.map(prePm=>prePm()));};
  Cls.prototype.loadFile=function(load,emsg){
    const that=this;
    return that.preProm((ok,err)=>{
      try{
        const r=new FileReader();
        r.onloadend=e=>{
          if(e.target.error){
            err(that.excp(emsg,e.target.error));
          }else{
            ok(e.target.result);
          }
        };
        load(r);
      }catch(t){
        err(that.excp(emsg,t));
      }
    });
  };
  Cls.prototype.loadAsUrl=function(file,emsg){return this.loadFile(r=>r.readAsDataURL(file),emsg);};
  return new Cls();
})();
const Toast=((kit)=>{
  let _elmt=null;
  let _timeout=null;
  const Cls=function(){};
  Cls.prototype.show=function(msg,type,relaTo,offset,duration){
    if(!_elmt){
      _elmt=kit.celmt('div');
      _elmt.className='toast';
      _elmt.style.display='none';
      document.body.appendChild(_elmt);
    }
    this.hide();
    kit.setText(_elmt,msg);
    _elmt.style.backgroundColor=type==='error'?'pink':type==='warn'?'yellow':type==='success'?'lightgreen':'lightblue';
    _elmt.style.borderColor=type==='error'?'red':type==='warn'?'orange':type==='success'?'green':'blue';
    _elmt.style.position='fixed';
    let left=0,top=0;
    if(relaTo){
      _elmt.style.position='absolute';
      left=isFinite(relaTo.offsetLeft)?Number(relaTo.offsetLeft):0;
      top=isFinite(relaTo.offsetTop)?Number(relaTo.offsetTop):0;
    }
    _elmt.style.visibility='hidden';
    _elmt.style.display='inline-flex';
    if(!offset){
      let offLeft=(window.innerWidth-_elmt.offsetWidth)/2;
      let offTop=(window.innerHeight-_elmt.offsetHeight)/2;
      offset=[offLeft>=0?offLeft:0,offTop>=0?offTop:0];
    }
    _elmt.style.left=(left+offset[0])+'px';
    _elmt.style.top=(top+offset[1])+'px';
    _elmt.style.visibility='visible';
    if(duration==null){
      duration=1500;
    }
    if(duration>=0){
      _timeout=setTimeout(()=>this.hide(),duration);
    }
  };
  Cls.prototype.hide=function(){
    _timeout&&clearTimeout(_timeout);
    _timeout=null;
    if(_elmt){
      _elmt.style.display='none';
      kit.setText(_elmt,'');
    }
  };
  return new Cls();
})(Kit);
const VerHis=(kit=>{
  let _data=null;
  const Cls=function(){};
  // data format:
  // {
  //   cols: {
  //     titles: ['Col 1','Col 2','Col 3'],
  //     thClses: ['alignCenter','',''],
  //     tdClses: ['nowrap','nowrap','']
  //   },
  //   rows: {
  //     rowData: [
  //       ['Key 1','Date 1','Comments 1'],
  //       ['Key 2','Date 2','Comments 2'],
  //       ['Key 3','Date 3','Comments 3']
  //     ],
  //     trClses: ['even','odd','even']
  //   }
  // }
  Cls.prototype.init=function(tbl,data){
    _data=data;
    tbl.innerHTML='';
    if(!(data&&data.cols&&data.cols.titles&&data.cols.titles.length>0)){
      return;
    }
    const thead=kit.celmt('thead');
    const tr=kit.celmt('tr');
    data.cols.titles.forEach((title,c)=>{
      const th=kit.celmt('th');
      kit.notEmpty(title)&&kit.setText(th,title);
      data.cols.thClses&&kit.notEmpty(data.cols.thClses[c])&&(th.className=data.cols.thClses[c]);
      tr.appendChild(th);
    });
    thead.appendChild(tr);
    tbl.appendChild(thead);
    const tbody=kit.celmt('tbody');
    data.rows&&data.rows.rowData&&data.rows.rowData.forEach((ctnts,r)=>{
      const tr=kit.celmt('tr');
      ctnts&&ctnts.forEach((ctnt,c)=>{
        const td=kit.celmt('td');
        kit.notEmpty(ctnt)&&kit.setText(td,ctnt);
        data.cols.tdClses&&kit.notEmpty(data.cols.tdClses[c])&&(td.className=data.cols.tdClses[c]);
        tr.appendChild(td);
      });
      data.rows.trClses&&kit.notEmpty(data.rows.trClses[r])&&(tr.className=data.rows.trClses[r]);
      tbody.appendChild(tr);
    });
    tbl.appendChild(tbody);
  };
  Cls.prototype.getCtnt=function(r,c){
    return _data&&_data.rows&&_data.rows.rowData&&_data.rows.rowData[r]&&_data.rows.rowData[r][c];
  };
  return new Cls();
})(Kit);
const HotKey=((kit)=>{
  let _map=null;
  const Cls=function(){};
  Cls.prototype.reg=function(key,dom,handler){
    if(!_map){
      _map={};
      document.addEventListener('keypress',e=>{
        console.log(e.keyCode);
        const handler=_map[e.keyCode];
        handler&&handler();
      });
    }
    _map[key.charCodeAt(0)]=handler;
    kit.setText(dom,dom.innerHTML+'['+key.charAt(0)+']');
  };
  Cls.prototype.ignoreOn=function(doms){
    doms.forEach(dom=>dom.addEventListener('keypress',e=>e.stopPropagation()));
  };
  return new Cls();
})(Kit);

const DOM={};
const initDom=()=>document.body.querySelectorAll('*').forEach(e=>e.id&&(DOM[e.id]=e));
const initDownSelf=htmlCtnt=>DOM.saveMe.href=URL.createObjectURL(new Blob([htmlCtnt],{type:'text/html'}));
const initVerHis=()=>{
  VerHis.init(DOM.verHis,{
    cols:{titles:['版本','日期','备注'],tdClses:['noWrap','noWrap','wordWrap']},
    rows:{rowData:_VER_HIS}
  });
  const ver=VerHis.getCtnt(_VER_HIS.length-1,0);
  document.title+=ver;
  Kit.setText(DOM.ver,ver);
};
const initHotKey=()=>{
  HotKey.reg('e',DOM.encBtn,()=>DOM.encBtn.click());
  HotKey.reg('d',DOM.decBtn,()=>DOM.decBtn.click());
  HotKey.reg('c',DOM.copyBtn,()=>DOM.copyBtn.click());
  HotKey.reg('r',DOM.resetBtn,()=>DOM.resetBtn.click());
  HotKey.ignoreOn([DOM.b64Str]);
};

const initEnc=()=>{
  DOM.selFile.onchange=()=>{
    const cnt=DOM.selFile.files.length;
    if(cnt===0){
      return;
    }
    const queue=[];
    let total=0;
    for(let i=0;i<cnt;i++){
      const file=DOM.selFile.files[i];
      total+=file.size;
      queue[i]=()=>Kit.loadAsUrl(file,'读取文件"'+file.name+'"失败。')().then(url=>({name:file.name,data:url}));
    }
    if(total>_META.warnSize){
      if(!confirm('所选文件总大小超过了'+_META.warnText+'，可能造成卡顿或页面崩溃，确定继续吗？')){
        DOM.selFile.value='';
        return;
      }
    }
    DOM.selFile.value='';
    Kit.serial(queue)().then(results=>{
      DOM.b64Str.value=JSON.stringify(results);
    }).catch(e=>{
      console.error(e);
      Toast.show(e.msg||'编码失败。','error');
    });
  };
  DOM.encBtn.onclick=()=>DOM.selFile.click();
};
const initDec=()=>{
  DOM.decBtn.onclick=()=>{
    if(Kit.empty(DOM.b64Str.value)){
      Toast.show('无内容。','warn',DOM.b64Str,[10,10]);
      return;
    }
    try{
      const b64s=JSON.parse(DOM.b64Str.value);
      if(!(b64s.length>0)){
        Kit.setText(DOM.decResult,'解析无结果。');
        return;
      }
      Kit.setText(DOM.decResult,'');
      b64s.forEach(item=>{
        const type=item.data.substring(5,item.data.indexOf(';')).split('/')[0].toLowerCase();
        const box=Kit.celmt('div');
        box.className='mTopS';
        box.innerHTML='<hr/>'
          +'<div class="breakWord">'
            +'<a href="javascript:;">保存</a>'
            +'<span class="mLeftM"></span>'
          +'</div>';
        const down=box.querySelector('a');
        down.download=item.name;
        down.href=item.data;
        const info=box.querySelector('span');
        Kit.setText(info,item.name);
        const resultBox=Kit.celmt('div');
        let elmt=null;
        switch(type){
          case 'video':
            elmt=Kit.celmt('video');
            elmt.controls=true;
            break;
          case 'audio':
            elmt=Kit.celmt('audio');
            elmt.controls=true;
            break;
          default:
            elmt=Kit.celmt('img');
            elmt.alt=item.name;
        }
        elmt.src=item.data;
        resultBox.appendChild(elmt);
        box.appendChild(resultBox);
        DOM.decResult.appendChild(box);
      });
    }catch(e){
      console.error(e);
      Toast.show('Base64字符串解析失败。','error');
    }
  };
};
const initCopy=()=>{
  DOM.copyBtn.onclick=e=>{
    const val=DOM.b64Str.value;
    if(val){
      navigator.clipboard.writeText(val).then(()=>Toast.show('内容已复制到剪贴板。','success',DOM.b64Str,[10,10]),err=>{
        console.error(err);
        Toast.show('复制内容到剪贴板失败。','error',DOM.b64Str,[10,10]);
      });
    }else{
      Toast.show('无内容。','warn',DOM.b64Str,[10,10]);
    }
  };
};
const initReset=()=>DOM.resetBtn.onclick=()=>{DOM.mainForm.reset();Kit.setText(DOM.decResult,'')};

window.onload=()=>{
  initDom();
  initDownSelf('<!DOCTYPE '+'html>'+document.documentElement.outerHTML);
  initVerHis();
  initHotKey();
  initEnc();
  initDec();
  initCopy();
  initReset();
};

})();
</script>
</head>
<body>
<div class="container">
  <h2>Base64文件转移<span id="ver"></span><br/><span class="remark">by: Use MiniCD</span></h2>
  <div><span class="declare">免责声明：本工具仅用于学习研究目的，任何使用本工具造成的影响与后果均由使用者全权负责！</span></div>
  <form id="mainForm">
    <input id="selFile" type="file" multiple="multiple" style="display:none;"/>
    <textarea id="b64Str" class="mTopS" rows="8" style="width:100%;resize:vertical;"></textarea><br/>
    <button id="encBtn" type="button" class="mTopS">编码</button
    ><button id="decBtn" type="button" class="mTopS mLeftM">解码</button
    ><button id="copyBtn" type="button" class="mTopS mLeftM">复制</button
    ><button id="resetBtn" type="button" class="mTopS mLeftM">重置</button><br/>
    <div id="decResult" class="mTopS"></div>
  </form>
  <h3>说明</h3>
  <ul>
    <li>Base64文件转移专用于小文件传输，常用于不方便直接传文件的场景。</li>
    <li>可将一组文件转为字符串，通过其它途径发送到另一设备。</li>
    <li>在另一设备上可将收到的字符串再转回文件，以便查看与保存。</li>
    <li>支持在页面直接预览图片、视频、音频等媒体文件。</li>
    <li>按钮或标签后[]内字符为快捷键。</li>
  </ul>
  <div class="mTopS"><a id="saveMe" href="javascript:;" download="b64_transfer.html">保存Base64文件转移</a> (保存的html文件可使用支持HTML5的浏览器打开)</div>
  <table id="verHis" class="mTopS remark"></table>
</div>
<div id="toast" class="toast" style="display:none;"></div>
<script type="text/javascript">

/*

window.onload=()=>{

const selfHtml='<!DOCTYPE '+'html>'+document.documentElement.outerHTML;
const META={
  clk:{
    suggestSizes:['400K','800K','1.5M','3M'],
    warnSizeUnit:20*1024*1024,
    downloadName:'cloak.png'
  },
  dcl:{
    warnCnt:100
  },
  errs:{}
};
META.errs[CF.ERR.CLOAK_FAIL]='创建失败.';
META.errs[CF.ERR.DECLOAK_FAIL]='现形失败.';
META.errs[CF.ERR.DECLOAK_CROSS_ORIGIN_ERR]='现形失败. (图片所在服务器禁止跨域访问，请下载图片后再现形)';
META.errs[CF.ERR.INFILE_INVLD]='里文件数据有误.';
const CACHE={};

const dAllFold=document.getElementById('allFold');
const dAllCloak=document.getElementById('allCloak');
const dAllDecloak=document.getElementById('allDecloak');
const dVer=document.getElementById('ver');
const dVerHis=document.getElementById('verHis');
const dSections=document.getElementsByTagName('details');
const dCloakSec=document.getElementById('cloakSec');
const dDecloakSec=document.getElementById('decloakSec');
const dClkTitle=document.getElementById('clkTitle');
const dDclTitle=document.getElementById('dclTitle');
const dDownSelf=document.getElementById('downSelf');

const dClkForm=document.getElementById('clkForm');
const dClkOut=document.getElementById('clkOut');
const dClkIn=document.getElementById('clkIn');
const dClkOutBtn=document.getElementById('clkOutBtn');
const dClkOutLbl=document.getElementById('clkOutLbl');
const dClkInBtn=document.getElementById('clkInBtn');
const dClkInLbl=document.getElementById('clkInLbl');
const dClkAddRemark=document.getElementById('clkAddRemark');
const dClkRemark=document.getElementById('clkRemark');
const dClkMaxLv=document.getElementById('clkMaxLv');
const dClkSuggestSize=document.getElementById('clkSuggestSize');
const dClkMinWidth=document.getElementById('clkMinWidth');
const dClkMinHeight=document.getElementById('clkMinHeight');
const dClkShrink=document.getElementById('clkShrink');
const dClkReset=document.getElementById('clkReset');
const dClkGo=document.getElementById('clkGo');
const dClkResultBar=document.getElementById('clkResultBar');
const dClkSave=document.getElementById('clkSave');
const dClkToggle=document.getElementById('clkToggle');
const dClkShowType=document.getElementById('clkShowType');
const dClkInfo=document.getElementById('clkInfo');
const dClkShowTypePop=document.getElementById('clkShowTypePop');
const dClkShowTypeImage=document.getElementById('clkShowTypeImage');
const dClkShowTypeVideo=document.getElementById('clkShowTypeVideo');
const dClkShowTypeAudio=document.getElementById('clkShowTypeAudio');
const dClkResult=document.getElementById('clkResult');

const dDclForm=document.getElementById('dclForm');
const dDclImgs=document.getElementById('dclImgs');
const dDclReset=document.getElementById('dclReset');
const dDclImgsBtn=document.getElementById('dclImgsBtn');
const dDclImgsLbl=document.getElementById('dclImgsLbl');
const dDclNetGo=document.getElementById('dclNetGo');
const dDclNetUrl=document.getElementById('dclNetUrl');
const dDclStatus=document.getElementById('dclStatus');
const dDclResults=document.getElementById('dclResults');

const busyDoms=[dAllCloak,dAllDecloak,dClkOut,dClkIn,dClkOutBtn,dClkInBtn,dClkAddRemark,dClkRemark,dClkMaxLv,dClkMinWidth,dClkMinHeight,dClkShrink,dClkGo,dDclImgs,dDclImgsBtn,dDclNetGo,dDclNetUrl];

const setText=(dom,text)=>{
  dom.innerHTML="";
  text&&dom.appendChild(document.createTextNode(text));
};
const toggleDomsSts=(doms,enable)=>doms.forEach(dom=>dom.disabled=!enable);
const toggleSec=sec=>sec.open=!sec.open;
const buildCache=(cloakName,cloakUrl,inName,inType,inUrl,cloak,showType)=>({
  cloakName:cloakName,
  cloakUrl:cloakUrl,
  inName:inName,
  inType:inType,
  inUrl:inUrl,
  cloak:cloak,
  showType:showType
});
const switchShowType=(cache,resultBox,showTypeSwitcher,hint)=>{
  resultBox.innerHTML='';
  let inDom=null;
  let typeTxt=null;
  switch(cache.showType){
    case 'video':
      inDom=document.createElement('video');
      inDom.controls=true;
      typeTxt='视频';
      break;
    case 'audio':
      inDom=document.createElement('audio');
      inDom.controls=true;
      typeTxt='音频';
      break;
    default:
      inDom=document.createElement('img');
      inDom.alt=hint;
      typeTxt='图片';
  }
  inDom.src=cache.inUrl;
  resultBox.appendChild(inDom);
  showTypeSwitcher.innerHTML=typeTxt;
};
const toggleCloak=(cache,resultBox,showTypeSwitcher,resultInfo,hint)=>{
  if(cache){
    cache.cloak=!cache.cloak;
    if(cache.cloak){
      resultBox.innerHTML='';
      showTypeSwitcher.style.display='none';
      setText(resultInfo,'坦克: '+cache.cloakName);
      const img=new Image();
      img.alt=hint;
      img.src=cache.cloakUrl;
      resultBox.appendChild(img);
    }else{
      setText(resultInfo,'里文件: '+cache.inName);
      switchShowType(cache,resultBox,showTypeSwitcher,hint);
      showTypeSwitcher.style.display='inline';
    }
  }
};
const toggleBusy=busy=>{
  toggleDomsSts(busyDoms,!busy);
  busy||clkUpdRemarkSts();
};
const updIptFileLbl=(lblDom,fileDom)=>setText(lblDom,fileDom.files.length<=0?'':fileDom.files.length===1?fileDom.files[0].name:fileDom.files.length+'个文件');
const isDomInside=(dom,parent)=>{
  let cur=dom;
  while(cur){
    if(cur===parent){
      return true;
    }
    cur=cur.parentElement;
  }
  return false;
};
const openPopup=(pop,left,top)=>setTimeout(()=>{
  left!=null&&(pop.style.left=left+'px');
  top!=null&&(pop.style.top=top+'px');
  let has=false;
  for(let i=0;i<CACHE.openPopups.length;i++){
    if(pop===CACHE.openPopups[i]){
      has=true;
      break;
    }
  }
  !has&&CACHE.openPopups.push(pop);
  pop.style.display='block';
},0);
const closePopup=pop=>{
  for(let i=0;i<CACHE.openPopups.length;i++){
    if(pop===CACHE.openPopups[i]){
      CACHE.openPopups.splice(i,1);
      break;
    }
  }
  pop.style.display='none';
};
const closeAllPopups=excludes=>{
  const news=[];
  CACHE.openPopups.forEach(pop=>{
    let exc=false;
    if(excludes){
      excludes=Array.isArray(excludes)?excludes:[excludes];
      for(let i=0;i<excludes.length;i++){
        if(isDomInside(excludes[i],pop)){
          exc=true;
          break;
        }
      }
    }
    exc?news.push(pop):(pop.style.display='none');
  });
  CACHE.openPopups=news;
};
const openShowTypePop=(cache,switcher,pop)=>{
  pop.querySelectorAll('span[c_showtype]').forEach(e=>{
    e.children[0].style.display='none';
    e.children[1].style.display='none';
    e.children[e.getAttribute('c_showtype')===cache.showType?1:0].style.display='inline';
  });
  openPopup(pop,switcher.offsetLeft,switcher.offsetTop+switcher.offsetHeight);
};
CACHE.openPopups=[];
document.onclick=e=>{
  closeAllPopups(e.target);
};

const clkUpdRemarkSts=()=>dClkRemark.disabled=!dClkAddRemark.checked;
const clkUpdSuggestSize=()=>setText(dClkSuggestSize,META.clk.suggestSizes[parseInt(dClkMaxLv.value)]);
const clkToggleCloak=()=>toggleCloak(CACHE.clk,dClkResult,dClkShowType,dClkInfo,'创建完成');
const clkOpenShowTypePop=()=>openShowTypePop(CACHE.clk,dClkShowType,dClkShowTypePop);
const clkSwitchShowType=evt=>{
  const item=evt.target.parentElement;
  closePopup(item.parentElement);
  CACHE.clk.showType=item.getAttribute('c_showtype');
  switchShowType(CACHE.clk,dClkResult,dClkShowType,'创建完成');
}
const clkClearCache=()=>{
  CACHE.clk&&CACHE.clk.cloakUrl&&URL.revokeObjectURL(CACHE.clk.cloakUrl);
  delete CACHE.clk;
};
const clkReset=()=>{
  clkClearCache();
  dClkForm.reset();
  updIptFileLbl(dClkOutLbl,dClkOut);
  updIptFileLbl(dClkInLbl,dClkIn);
  clkUpdRemarkSts();
  clkUpdSuggestSize();
  dClkSave.href='javascript:;';
  dClkSave.removeAttribute('download');
  setText(dClkInfo,'');
  dClkResult.innerHTML='';
  dClkResultBar.style.display='none';
};
const clkGo=()=>{
  const outFile=dClkOut.files[0];
  const inFile=dClkIn.files[0];
  const outEmsg='表图读取失败.';
  const inEmsg='里文件读取失败.';
  const maxLv=parseInt(dClkMaxLv.value)+1;
  const minWidth=parseInt(dClkMinWidth.value);
  const minHeight=parseInt(dClkMinHeight.value);
  if(minWidth<dClkMinWidth.min||minWidth>dClkMinWidth.max){
    alert('最小宽度必须在'+dClkMinWidth.min+'到'+dClkMinWidth.max+'之间.');
    return;
  }
  if(minHeight<dClkMinHeight.min||minHeight>dClkMinHeight.max){
    alert('最小高度必须在'+dClkMinHeight.min+'到'+dClkMinHeight.max+'之间.');
    return;
  }
  const warnSize=META.clk.warnSizeUnit*maxLv;
  if(inFile&&inFile.size>warnSize){
    const warnMsg=Math.floor(warnSize/(1024*1024))+'MB';
    if(!confirm('你选择的里文件大小超过'+warnMsg+'，在当前最大压缩度下生成的坦克图片尺寸将过大，可能会生成失败并造成页面崩溃，确定继续吗？')){
      dClkIn.value='';
      return;
    }
  }
  toggleBusy(true);
  setTimeout(()=>UT.parallel([
    UT.loadAsUrl(outFile,outEmsg),
    UT.loadAsBuff(inFile,inEmsg)
  ])().then(loadResults=>UT.parallel([
    CF.cloak({
      outUrl:loadResults[0],
      inBuff:loadResults[1],
      outName:META.clk.downloadName,
      inName:inFile.name,
      inType:inFile.type,
      remark:dClkAddRemark.checked?dClkRemark.value:null,
      maxLv:maxLv,
      minWidth:minWidth,
      minHeight:minHeight,
      shrink:dClkShrink.value
    }),
    UT.loadAsUrl(inFile,inEmsg)
  ])()).then(clkResults=>{
    try{
      clkClearCache();
      let showType=inFile.type.split('/')[0].toLowerCase();
      if(showType!=='video'&&showType!=='audio'){
        showType='image';
      }
      CACHE.clk=buildCache(clkResults[0].name,URL.createObjectURL(clkResults[0]),inFile.name,inFile.type,clkResults[1],false,showType);
      dClkSave.href=CACHE.clk.cloakUrl;
      dClkSave.download=clkResults[0].name;
      dClkResultBar.style.display='block';
      clkToggleCloak();
      return Promise.resolve();
    }catch(t){
      return Promise.reject(new UT.Excp(CF.ERR.CLOAK_FAIL,t));
    }
  }).catch(e=>{
    console.error(e);
    alert(META.errs[e.msg]||e.msg);
  }).finally(()=>{
    toggleBusy(false);
  }),0);
};
dClkOutBtn.onclick=()=>dClkOut.click();
dClkInBtn.onclick=()=>dClkIn.click();
dClkOut.onchange=()=>updIptFileLbl(dClkOutLbl,dClkOut);
dClkIn.onchange=()=>updIptFileLbl(dClkInLbl,dClkIn);
dClkAddRemark.onchange=clkUpdRemarkSts;
dClkMaxLv.onchange=clkUpdSuggestSize;
dClkReset.onclick=clkReset;
dClkGo.onclick=clkGo;
dClkToggle.onclick=clkToggleCloak;
dClkShowType.onclick=clkOpenShowTypePop;
dClkShowTypeImage.onclick=clkSwitchShowType;
dClkShowTypeVideo.onclick=clkSwitchShowType;
dClkShowTypeAudio.onclick=clkSwitchShowType;
clkReset();

const dclUpdSts=()=>{
  if(CACHE.dcl){
    const total=CACHE.dcl.files.length;
    const done=CACHE.dcl.done;
    setText(dDclStatus,(done===total?'现形完毕.':'现形中...')+' ('+done+'/'+total+')');
  }else{
    setText(dDclStatus,'');
  }
};
const dclToggleCloak=i=>CACHE.dcl&&toggleCloak(CACHE.dcl.files[i],document.getElementById('dclResult'+i),document.getElementById('dclShowType'+i),document.getElementById('dclInfo'+i),'现形完成');
const dclOpenShowTypePop=i=>CACHE.dcl&&openShowTypePop(CACHE.dcl.files[i],document.getElementById('dclShowType'+i),document.getElementById('dclShowTypePop'+i));
const dclSwitchShowType=(evt,i)=>{
  const item=evt.target.parentElement;
  closePopup(item.parentElement);
  CACHE.dcl.files[i].showType=item.getAttribute('c_showtype');
  switchShowType(CACHE.dcl.files[i],document.getElementById('dclResult'+i),document.getElementById('dclShowType'+i),'现形完成');
}
const dclClearCache=()=>{
  CACHE.dcl&&CACHE.dcl.files&&CACHE.dcl.files.forEach(file=>URL.revokeObjectURL(file.inUrl));
  delete CACHE.dcl;
};
const dclReset=()=>{
  dclClearCache();
  dDclForm.reset();
  updIptFileLbl(dDclImgsLbl,dDclImgs);
  dclUpdSts();
  dDclStatus.style.display='none';
  dDclResults.innerHTML='';
  dDclResults.style.display='none';
};
const dclViewer=(item,i,nameUrlGetter)=>UT.preProm(ok=>setTimeout(()=>{
  nameUrlGetter(item)().then(nameUrl=>UT.parallel([
    ()=>Promise.resolve(nameUrl[0]),
    ()=>Promise.resolve(nameUrl[1]),
    CF.decloak(nameUrl[1])
  ])()).then(dclResults=>{
    try{
      let showType=dclResults[2].type.split('/')[0].toLowerCase();
      if(showType!=='video'&&showType!=='audio'){
        showType='image';
      }
      CACHE.dcl.files[i]=buildCache(dclResults[0],dclResults[1],dclResults[2].name,dclResults[2].type,URL.createObjectURL(dclResults[2]),true,showType);
      const dDclSave=document.getElementById('dclSave'+i);
      dDclSave.href=CACHE.dcl.files[i].inUrl;
      dDclSave.download=CACHE.dcl.files[i].inName;
      const dDclToggle=document.getElementById('dclToggle'+i);
      if(!dDclToggle.onclick){
        dDclToggle.onclick=()=>dclToggleCloak(i);
      }
      document.getElementById('dclShowType'+i).onclick=()=>dclOpenShowTypePop(i);
      document.getElementById('dclShowTypeImage'+i).onclick=e=>dclSwitchShowType(e,i);
      document.getElementById('dclShowTypeVideo'+i).onclick=e=>dclSwitchShowType(e,i);
      document.getElementById('dclShowTypeAudio'+i).onclick=e=>dclSwitchShowType(e,i);
      document.getElementById('dclResultBar'+i).style.display='block';
      dclToggleCloak(i);
      return Promise.resolve();
    }catch(t){
      return Promise.reject(new UT.Excp(CF.ERR.DECLOAK_FAIL,t));
    }
  }).catch(e=>{
    console.error(e);
    setText(document.getElementById('dclResult'+i),META.errs[e.msg]||e.msg);
  }).finally(()=>{
    CACHE.dcl.done++;
    dclUpdSts();
    ok();
  });
},0));
const dclGo=(items,viewer)=>{
  const cnt=items.length;
  let goon=cnt>0;
  if(cnt>=META.dcl.warnCnt){
    goon=window.confirm('你一次打开了超过'+META.dcl.warnCnt+'张图片，将占用较多内存并且可能造成页面崩溃，确定继续吗？');
  }
  if(!goon){
    dDclImgs.value='';
    return;
  }
  toggleBusy(true);
  dclClearCache();
  CACHE.dcl={
    files:new Array(cnt),
    done:0
  };
  dclUpdSts();
  dDclStatus.style.display='block';
  dDclResults.innerHTML='';
  dDclResults.style.display='block';
  const queue=[];
  for(let i=0;i<cnt;i++){
    const v=viewer(items[i],i);
    const box=document.createElement('div');
    box.className='mTopS';
    box.innerHTML='<hr/>'
      +'<div id="dclResultBar'+i+'" class="breakWord" style="display:none;">'
        +'<a id="dclSave'+i+'" href="javascript:;">保存里文件</a>'
        +'<a id="dclToggle'+i+'" class="mLeftM" href="javascript:;">切换</a>'
        +'<a id="dclShowType'+i+'" class="mLeftM" href="javascript:;"></a>'
        +'<span id="dclInfo'+i+'" class="mLeftM"></span>'
        +'<div id="dclShowTypePop'+i+'" class="popup" style="display:none;">'
          +'<span c_showtype="image"><a id="dclShowTypeImage'+i+'" href="javascript:;">图片</a><span>图片</span></span>'
          +'<span c_showtype="video"><a id="dclShowTypeVideo'+i+'" href="javascript:;">视频</a><span>视频</span></span>'
          +'<span c_showtype="audio"><a id="dclShowTypeAudio'+i+'" href="javascript:;">音频</a><span>音频</span></span>'
        +'</div>'
      +'</div>'
      +'<div id="dclResult'+i+'"/>坦克现形中...</div>';
    dDclResults.appendChild(box);
    queue.push(v);
  }
  UT.serial(queue)().finally(()=>toggleBusy(false));
};
const dclLocalGo=()=>{
  updIptFileLbl(dDclImgsLbl,dDclImgs);
  const files=dDclImgs.files;
  dclGo(files,(file,i)=>dclViewer(file,i,f=>UT.parallel([
    ()=>Promise.resolve(f.name),
    UT.loadAsUrl(f,'坦克读取失败.')
  ])));
};
const dclNetGo=()=>{
  const netUrlStr=dDclNetUrl.value;
  if(!netUrlStr){
    return;
  }
  const netUrls=netUrlStr.split('\n').filter(url=>!!url);
  dclGo(netUrls,(url,i)=>dclViewer(url,i,u=>{
    const lastSlashIdx=u.lastIndexOf('/');
    let name=lastSlashIdx>=0?u.substring(lastSlashIdx+1):u;
    name=name||u;
    return ()=>Promise.resolve([name,u]);
  }));
};
dDclReset.onclick=dclReset;
dDclImgsBtn.onclick=()=>dDclImgs.click();
dDclImgs.onchange=dclLocalGo;
dDclNetGo.onclick=dclNetGo;
dclReset();

const foldAll=()=>{
  for(let i=0;i<dSections.length;i++){
    dSections[i].open=false;
  }
};
const allToggle=clk=>{
  const queue=[];
  if(CACHE.clk&&CACHE.clk.cloak!==clk){
    queue.push(UT.preProm(ok=>setTimeout(()=>{
      clkToggleCloak();
      ok();
    },0)));
  }
  if(CACHE.dcl&&CACHE.dcl.files){
    CACHE.dcl.files.forEach((file,i)=>{
      if(file&&file.cloak!==clk){
        queue.push(UT.preProm(ok=>setTimeout(()=>{
          dclToggleCloak(i);
          ok();
        },0)));
      }
    });
  }
  if(queue.length>0){
    toggleBusy(true);
    UT.serial(queue)().finally(()=>toggleBusy(false));
  }
};
const updVer=()=>{
  const ver=dVerHis.querySelectorAll('tbody>tr:last-child>td:first-child')[0].innerHTML;
  document.title+=ver;
  setText(dVer,ver);
};
dAllFold.onclick=foldAll;
dAllCloak.onclick=()=>allToggle(true);
dAllDecloak.onclick=()=>allToggle(false);
updVer();
dDownSelf.href=URL.createObjectURL(new Blob([selfHtml],{type:"text/html"}));

const hotKeyMap={};
const regHotKey=(key,dom,cbk)=>{
  hotKeyMap[key.charCodeAt(0)]=cbk;
  setText(dom,dom.innerHTML+'['+key.charAt(0)+']');
};
const applyHotKey=()=>{
  document.addEventListener('keypress',e=>{
    console.log(e.keyCode);
    const handler=hotKeyMap[e.keyCode];
    handler&&handler();
  });
};
const stopHotKey=e=>e.stopPropagation();
const stopHotKeyOnDoms=doms=>doms.forEach(dom=>dom.addEventListener('keypress',stopHotKey));
regHotKey('f',dAllFold,()=>dAllFold.click());
regHotKey('c',dAllCloak,()=>dAllCloak.click());
regHotKey('d',dAllDecloak,()=>dAllDecloak.click());
regHotKey('1',dClkTitle,()=>toggleSec(dCloakSec));
regHotKey('2',dDclTitle,()=>toggleSec(dDecloakSec));
regHotKey('o',dClkOutBtn,()=>dClkOutBtn.click());
regHotKey('i',dClkInBtn,()=>dClkInBtn.click());
regHotKey('m',dClkGo,()=>dClkGo.click());
regHotKey('s',dDclImgsBtn,()=>dDclImgsBtn.click());
regHotKey('a',dDclNetGo,()=>dDclNetGo.click());
applyHotKey();
stopHotKeyOnDoms([dClkRemark,dClkMaxLv,dClkMinWidth,dClkMinHeight,dClkShrink,dDclNetUrl]);

};
*/
</script>
</body>
</html>
